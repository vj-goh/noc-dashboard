version: '3.8'

services:
  # Core Network Router
  router1:
    image: frrouting/frr:latest
    container_name: noc_router1
    hostname: router1
    privileged: true
    volumes:
      - ./config/router1:/etc/frr
    networks:
      - core_network
      - edge_network
    command: >
      sh -c "chown -R frr:frr /etc/frr &&
             chmod 640 /etc/frr/frr.conf /etc/frr/daemons /etc/frr/vtysh.conf &&
             /usr/lib/frr/frrinit.sh start &&
             tail -f /dev/null"
    restart: unless-stopped

  # Edge Network Router
  router2:
    image: frrouting/frr:latest
    container_name: noc_router2
    hostname: router2
    privileged: true
    volumes:
      - ./config/router2:/etc/frr
    networks:
      - edge_network
      - client_network
    command: >
      sh -c "chown -R frr:frr /etc/frr &&
             chmod 640 /etc/frr/frr.conf /etc/frr/daemons /etc/frr/vtysh.conf &&
             /usr/lib/frr/frrinit.sh start &&
             tail -f /dev/null"
    restart: unless-stopped

  # RADIUS Server - Fixed to use custom Dockerfile
  radius:
    build:
      context: ./config/radius
      dockerfile: Dockerfile
    container_name: noc_radius
    hostname: radius
    networks:
      core_network:
        ipv4_address: 10.0.1.10
    ports:
      - "11812:1812/udp"
      - "11813:1813/udp"
    restart: unless-stopped

  # Network Scanner
  scanner:
    build:
      context: ./scanner
      dockerfile: Dockerfile
    container_name: noc_scanner
    hostname: scanner
    volumes:
      - ./scanner:/app
      - scan-data:/data
    networks:
      core_network:
        ipv4_address: 10.0.1.20
      edge_network:
        ipv4_address: 10.0.2.20
      client_network:
        ipv4_address: 10.0.3.20
    privileged: true
    restart: unless-stopped

  # DNS Server - Using dnsmasq instead of BIND9
  dns:
    image: strm/dnsmasq:latest
    container_name: noc_dns
    hostname: dns
    volumes:
      - ./config/dns/dnsmasq.conf:/etc/dnsmasq.conf:ro
    networks:
      core_network:
        ipv4_address: 10.0.1.40
    cap_add:
      - NET_ADMIN
    restart: unless-stopped

  # Client 1
  client1:
    image: alpine:latest
    container_name: noc_client1
    hostname: client1
    networks:
      client_network:
        ipv4_address: 10.0.3.10
    command: tail -f /dev/null
    restart: unless-stopped

  # Client 2
  client2:
    image: alpine:latest
    container_name: noc_client2
    hostname: client2
    networks:
      client_network:
        ipv4_address: 10.0.3.11
    command: tail -f /dev/null
    restart: unless-stopped

  # NOC Dashboard API
  api:
    build:
      context: ../noc-dashboard-api
      dockerfile: Dockerfile
    container_name: noc_api
    hostname: api
    ports:
      - "8001:8000"
    volumes:
      - //var/run/docker.sock:/var/run/docker.sock
      - ../noc-dashboard-api/app:/app/app
      - scan-data:/data
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - DEBUG=true
      - ROUTER1_CONTAINER=noc_router1
      - ROUTER2_CONTAINER=noc_router2
      - SCANNER_CONTAINER=noc_scanner
      - RADIUS_CONTAINER=noc_radius
      - DNS_CONTAINER=noc_dns
    networks:
      core_network:
        ipv4_address: 10.0.1.50
    depends_on:
      - router1
      - router2
      - scanner
      - radius
      - dns
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped

  # Dashboard Frontend - FIXED API URL!
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: noc_dashboard
    hostname: dashboard
    ports:
      - "5174:5173"
      - "3000:3000"
    volumes:
      - ./dashboard:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8001/api  # ‚Üê FIXED! Was 8000, now 8001
    networks:
      core_network:
        ipv4_address: 10.0.1.30
    depends_on:
      - api
    restart: unless-stopped

volumes:
  scan-data:

networks:
  core_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.1.0/24
  edge_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.2.0/24
  client_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.3.0/24